<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-127329943-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Frank&#39;s development blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Frank&apos;s development blog - Java, Rails, Python, Solr, Samvera, Hyrax, Blacklights">
<meta name="keywords" content="Java, Rails, Python, Solr, Samvera, Hyrax, Blacklights">
<meta property="og:type" content="website">
<meta property="og:title" content="Frank&#39;s development blog">
<meta property="og:url" content="https://yfrankfeng.github.io/index.html">
<meta property="og:site_name" content="Frank&#39;s development blog">
<meta property="og:description" content="Frank&apos;s development blog - Java, Rails, Python, Solr, Samvera, Hyrax, Blacklights">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Frank&#39;s development blog">
<meta name="twitter:description" content="Frank&apos;s development blog - Java, Rails, Python, Solr, Samvera, Hyrax, Blacklights">
  
    <link rel="alternate" href="/atom.xml" title="Frank&#39;s development blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Frank&#39;s development blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Java, Rails, Python, Solr, Samvera, Hyrax, Blacklights</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://yfrankfeng.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-aws-s3-localstack" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/aws-s3-localstack/" class="article-date">
  <time datetime="2019-12-06T16:36:16.217Z" itemprop="datePublished">2019-12-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/aws/">aws</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/aws-s3-localstack/">AWS S3 localstack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Below is just my notes following this tutorial: <a href="https://dev.to/goodidea/how-to-fake-aws-locally-with-localstack-27me" target="_blank" rel="noopener">https://dev.to/goodidea/how-to-fake-aws-locally-with-localstack-27me</a></p>
<h2 id="LocalStack"><a href="#LocalStack" class="headerlink" title="LocalStack"></a>LocalStack</h2><p><a href="https://github.com/localstack/localstack" target="_blank" rel="noopener">Localstack</a> allows you to play AWS services on your PC. Lots of AWS services are supported by localstack.  </p>
<p>The benefits of using localstack:</p>
<ul>
<li>Work offline</li>
<li>You have full control of your own dev environment</li>
<li>You can easily wipe &amp; replace your local buckets</li>
<li>Free!</li>
</ul>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>Make sure you have installed the following: </p>
<ul>
<li>Docker</li>
<li>AWS CLI</li>
<li>AWS being configured (if not, run aws configure to create some credentials), actually localstack doesn’t check your credentials, as long as they are not empty!</li>
</ul>
<p>Create a project folder and add some files</p>
<pre><code>mkdir test1
touch index.js docker-compose.yml .env
mkdir .localstack
</code></pre><p>Copy a image, e.g. test.jpg to your project folder.</p>
<p>Run the following commands to init the project and install npm packages:</p>
<pre><code>npm init 
npm install aws-sdk dotenv
</code></pre><p>Edit docker-compose.yml with content:</p>
<pre><code>version: &apos;3.2&apos;
services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack_demo
    ports:
      - &apos;4563-4599:4563-4599&apos;
      - &apos;8055:8080&apos;
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - &apos;./.localstack:/tmp/localstack&apos;
      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;
</code></pre><p>Start docker container:</p>
<pre><code>docker-compose up 
</code></pre><p>After a couple of minutes, you can access localstack UI via: <a href="http://localhost:8055/" target="_blank" rel="noopener">http://localhost:8055/</a></p>
<p><img src="/images/aws/localstack-s3-1.png" alt="localstack"></p>
<p>And local S3 UI: <a href="http://localhost:4572/" target="_blank" rel="noopener">http://localhost:4572/</a></p>
<p>Now AWS is inside your VM!</p>
<h2 id="Working-with-localstack"><a href="#Working-with-localstack" class="headerlink" title="Working with localstack"></a>Working with localstack</h2><p>Create a bucket in localstack:</p>
<pre><code>aws --endpoint-url=http://localhost:4572 s3 mb s3://demo-bucket
</code></pre><p>NB: the –endpoint-url specifies the localstack URL for s3</p>
<p>From the localstack logs (via Docker), you will see something like:</p>
<pre><code>localstack_demo | 2019-12-06 15:10:14,909:API: 127.0.0.1 - - [06/Dec/2019 15:10:14] &quot;PUT /demo-bucket HTTP/1.1&quot; 200 -
</code></pre><p>From the localstack S3 UI, you will see:</p>
<pre><code>&lt;Buckets&gt;
    &lt;Bucket&gt;
        &lt;Name&gt;demo-bucket&lt;/Name&gt;
        &lt;CreationDate&gt;2006-02-03T16:45:09.000Z&lt;/CreationDate&gt;
    &lt;/Bucket&gt;
&lt;/Buckets&gt;
</code></pre><p>Attach an ACL to the bucket:</p>
<pre><code>aws --endpoint-url=http://localhost:4572 s3api put-bucket-acl --bucket demo-bucket --acl public-read
</code></pre><p>Now, the S3 bucket is available in the localstack dashboard.</p>
<p>Check .localstack/data/s3_api_calls.json file</p>
<pre><code>{&quot;a&quot;: &quot;s3&quot;, &quot;m&quot;: &quot;PUT&quot;, &quot;p&quot;: &quot;/demo-bucket&quot;, &quot;d&quot;: &quot;XXXXXXXX&quot;, &quot;h&quot;: {&quot;host&quot;: &quot;localhost&quot;, &quot;Accept-Encoding&quot;: &quot;identity&quot;, &quot;User-Agent&quot;: &quot;aws-cli/1.16.183 Python/3.6.9 Linux/4.15.
0-72-generic botocore/1.12.253&quot;, &quot;X-Amz-Date&quot;: &quot;20191206T151014Z&quot;, &quot;X-Amz-Content-SHA256&quot;: &quot;xxxx&quot;, &quot;Authorization&quot;: &quot;AWS4-HMAC-SHA256 Credential=XXXXXX, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=xxxx&quot;, &quot;Content-Length&quot;: &quot;153&quot;, &quot;X-Forwarded-For&quot;: &quot;172.30.0.1, 0.0.0.0:4572&quot;, &quot;content-type&quot;: &quot;binary/octet-str
eam&quot;}}
{&quot;a&quot;: &quot;s3&quot;, &quot;m&quot;: &quot;PUT&quot;, &quot;p&quot;: &quot;/demo-bucket?acl&quot;, &quot;d&quot;: &quot;&quot;, &quot;h&quot;: {&quot;host&quot;: &quot;localhost&quot;, &quot;Accept-Encoding&quot;: &quot;identity&quot;, &quot;x-amz-a
cl&quot;: &quot;public-read&quot;, &quot;User-Agent&quot;: &quot;aws-cli/1.16.183 Python/3.6.9 Linux/4.15.0-72-generic botocore/1.12.253&quot;, &quot;X-Amz-Date&quot;: &quot;
20191206T151327Z&quot;, &quot;X-Amz-Content-SHA256&quot;: &quot;xxxx&quot;, &quot;Authorizatio
n&quot;: &quot;AWS4-HMAC-SHA256 Credential=xxxx&quot;, &quot;Content-Length&quot;: &quot;
0&quot;, &quot;X-Forwarded-For&quot;: &quot;172.30.0.1, 0.0.0.0:4572&quot;, &quot;content-type&quot;: &quot;binary/octet-stream&quot;}}
</code></pre><p>Edit .env file with content:</p>
<pre><code>AWS_ACCESS_KEY_ID=&apos;123&apos; 
AWS_SECRET_KEY=&apos;xyz&apos;
AWS_BUCKET_NAME=&apos;demo-bucket&apos;
</code></pre><p>Note: it doesn’t matter what your AWS key &amp; secret are, as long as they aren’t empty.</p>
<p>Create aws.js</p>
<pre><code>const AWS = require(&apos;aws-sdk&apos;)
require(&apos;dotenv&apos;).config()

const credentials = {
   accessKeyId: process.env.AWS_ACCESS_KEY_ID,
   secretAccessKey: process.env.AWS_SECRET_KEY,
}

const useLocal = process.env.NODE_ENV !== &apos;production&apos;

const bucketName = process.env.AWS_BUCKET_NAME

const s3client = new AWS.S3({
   credentials,

   endpoint: useLocal ? &apos;http://localhost:4572&apos; : undefined,
   s3ForcePathStyle: true,
})


const uploadFile = async (data, fileName) =&gt;
   new Promise((resolve) =&gt; {
      s3client.upload(
         {
            Bucket: bucketName,
            Key: fileName,
            Body: data,
         },
         (err, response) =&gt; {
            if (err) throw err
            resolve(response)
         },
      )
   })

module.exports = uploadFile
</code></pre><p>Create test-upload.js with content:</p>
<pre><code>const fs = require(&apos;fs&apos;)
const path = require(&apos;path&apos;)
const uploadFile = require(&apos;./aws&apos;)

const testUpload = () =&gt; {
    const filePath = path.resolve(__dirname, &apos;test.jpg&apos;)
    const fileStream = fs.createReadStream(filePath)
    const now = new Date()
    const fileName = `test-image-${now.toISOString()}.jpg`
    uploadFile(fileStream, fileName).then((response) =&gt; {
        console.log(&quot;:)&quot;)
        console.log(response)
    }).catch((err) =&gt; {
        console.log(&quot;:|&quot;)
        console.log(err)
    })
}

testUpload()
</code></pre><p>To test, run:</p>
<pre><code>node test-upload.js
</code></pre><p>From the output, you can find the image location, like: </p>
<pre><code>http://localhost:4572/demo-bucket/test-image-2019-12-06T15%3A28%3A57.037Z.jpg
</code></pre><p>If check .localstack/data/s3_api_calls.json file again, you will see the file containing image binary data.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/aws-s3-localstack/" data-id="ck3udhcdj0000wh05q1k9g56l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/">aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/localstack/">localstack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/s3/">s3</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-iris-migration" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/iris-migration/" class="article-date">
  <time datetime="2019-12-05T14:49:32.568Z" itemprop="datePublished">2019-12-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/iris-migration/">IRIS migration</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Hard-coded-fedora-URL"><a href="#Hard-coded-fedora-URL" class="headerlink" title="Hard-coded fedora URL"></a>Hard-coded fedora URL</h2><p>In src/main/java/uk/ac/york/dlib/yodling/service/repository/FedoraAPIMEndpoint.java, there are lots of hard-coded Fedora URL (localhost:880/fedora/objects) </p>
<p>In src/main/java/uk/ac/york/dlib/yodling/web/workflow/WorkflowController.java, between about L1454-L1482, and other places within that file.</p>
<h2 id="hard-coded-Solr-URL"><a href="#hard-coded-Solr-URL" class="headerlink" title="hard-coded Solr URL"></a>hard-coded Solr URL</h2><p>In src/main/java/uk/ac/york/dlib/yodling/service/search/SolrSearchService.java, solr is hard-coded:</p>
<pre><code>private static String pathToSolr = &quot;http://localhost:8080/solr/&quot;;
</code></pre><p>Now we need to turn this attribute to non-static, and use Spring to inject the Solr URL.</p>
<p>First, declare the attribute as:</p>
<pre><code>private String pathToSolr = &quot;http://localhost:8080/solr/&quot;;
</code></pre><p>Add constructors:</p>
<pre><code>public SolrSearchService() {
}

public SolrSearchService(String pathToSolr) {
    try {
        if(pathToSolr != null)
            this.pathToSolr   = pathToSolr;
        solrSearchServer  = new CommonsHttpSolrServer(this.pathToSolr);
    } catch (Exception e) {
        log.error(&quot;Exception while connecting to Solr&quot;, e);
    }
}
</code></pre><p>In Spring config file, e.g. web-application-config.xml, define:</p>
<pre><code>&lt;bean id=&quot;homeSearchService&quot; class=&quot;uk.ac.york.dlib.yodling.service.search.SolrSearchService&quot;   scope=&quot;prototype&quot;&gt;
    &lt;constructor-arg name=&quot;pathToSolr&quot; value=&quot;${solr.baseURL}&quot; /&gt;

    XXXXXXXXXXXX
&lt;/bean&gt;                
</code></pre><p> In yodl.properties, add:</p>
<pre><code>solr.baseURL=https://XXXX/solr
</code></pre><h2 id="hard-coded-XSLT-path"><a href="#hard-coded-XSLT-path" class="headerlink" title="hard coded XSLT path"></a>hard coded XSLT path</h2><pre><code>src/main/webapp/Content/xslt/downloadersorter.xsl
src/main/webapp/Content/xslt/iris2dc.xsl
src/main/webapp/Content/xslt/irisData4EmailAlerts.xsl
src/main/webapp/Content/xslt/updateDownloadCountPerInsType.xsl
src/main/webapp/Content/xslt/updatePreDataTypes.xsl
src/main/webapp/Content/xslt/updateDownloadCountPerRA.xsl
src/main/webapp/Content/xslt/updatePreDomainOfUse.xsl
src/main/webapp/Content/xslt/updatePreFunders.xsl
src/main/webapp/Content/xslt/updatePreInsType.xsl
src/main/webapp/Content/xslt/updatePreJournals.xsl
src/main/webapp/Content/xslt/updatePreLinguisticTargets.xsl
src/main/webapp/Content/xslt/updatePreParticipantTypes.xsl
src/main/webapp/Content/xslt/updatePreProficiencies.xsl
src/main/webapp/Content/xslt/updatePrePublishers.xsl
src/main/webapp/Content/xslt/updatePreRequired_software.xsl
src/main/webapp/Content/xslt/updatePreResearchAreas.xsl
</code></pre><p>Change all absolute paths to DD to something like:</p>
<pre><code>&lt;xsl:variable name=&quot;commonsDD&quot;  select=&quot;document(&apos;../xml/datadictionary/commons.xml&apos;, /)&quot;/&gt;
</code></pre><h2 id="Improvements"><a href="#Improvements" class="headerlink" title="Improvements"></a>Improvements</h2><h3 id="duplicated-web-xml-in-Tomcat-webapp-folders"><a href="#duplicated-web-xml-in-Tomcat-webapp-folders" class="headerlink" title="duplicated web.xml in Tomcat webapp folders"></a>duplicated web.xml in Tomcat webapp folders</h3><p>In pom.xml</p>
<pre><code>&lt;build&gt;
        &lt;sourceDirectory&gt;${basedir}/src/main/java&lt;/sourceDirectory&gt;
        &lt;outputDirectory&gt;${project.build.directory}/WebRoot/WEB-INF/classes&lt;/outputDirectory&gt;
        &lt;resources&gt;
            ......
            &lt;resource&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
                &lt;excludes&gt;
                    &lt;exclude&gt;**/*.properties&lt;/exclude&gt;
                    &lt;exclude&gt;**/*web-application-config.xml&lt;/exclude&gt;
                    &lt;exclude&gt;**/*web.xml&lt;/exclude&gt;
                &lt;/excludes&gt;
            &lt;/resource&gt;
        &lt;/resources&gt;   
......
&lt;/build&gt;         
</code></pre><h2 id="Orbeon-Engine"><a href="#Orbeon-Engine" class="headerlink" title="Orbeon Engine"></a>Orbeon Engine</h2><p>Download Orbeon 3.9 CE and extract the orbeon39.war. Stop Tomcat, Copy orbeon39.war to webapps, and Start Tomcat.</p>
<p>Edit Tomcat server.xml</p>
<pre><code>&lt;Host name=&quot;localhost&quot;  ...&gt;
    &lt;Context path=&quot;/orbeon39&quot; docBase=&quot;orbeon39&quot; crossContext=&quot;true&quot;/&gt;
    &lt;Context path=&quot;/iris&quot; docBase=&quot;iris&quot; crossContext=&quot;true&quot;/&gt;
</code></pre><p>Tried Orbeon 2019 CE but couldn’t get it working. The error message is not very useful:</p>
<p><img src="https://user-images.githubusercontent.com/437701/70224943-03601700-1746-11ea-8803-34824f3c3cf4.png" alt="image"></p>
<pre><code>2019-12-05 09:58:40,993 ERROR PageFlowControllerProcessor  - error caught {controller: &quot;oxf:/ops/xforms/xforms-renderer-pa$
2019-12-05 09:58:41,095 ERROR PageFlowControllerProcessor  -
+----------------------------------------------------------------------------------------------------------------------+
|An Error has Occurred                                                                                                 |
|----------------------------------------------------------------------------------------------------------------------|
|specified pattern is invalid: &apos;-&apos; is an invalid character range. Write &apos;\-&apos;.                                          |
|----------------------------------------------------------------------------------------------------------------------|
|Application Call Stack                                                                                                |
|----------------------------------------------------------------------------------------------------------------------|
|oxf:/ops/xforms/xforms-renderer-page-flow.xml                                     |reading page model data output|  23|
|····························································�$
|element=&lt;page path=&quot;/xforms-renderer&quot; model=&quot;xforms-renderer.xpl&quot;/&gt;                                                   |
|model  =xforms-renderer.xpl                                                                                           |
|----------------------------------------------------------------------------------------------------------------------|
|oxf:/ops/xforms/xforms-renderer.xpl                                               |executing processor           | 130|        
</code></pre><h2 id="logging-dependency-problem"><a href="#logging-dependency-problem" class="headerlink" title="logging dependency problem"></a>logging dependency problem</h2><p>The web app, e.g. iris working on local VM (Tomcat 9) but cannot start on dlibjavatest0 (Tomcat 8), and the error message is:</p>
<pre><code>17:08:12.571 SEVERE [http-nio-8080-exec-2] org.apache.catalina.core.StandardContext.listenerStart Exception sending context initialized event to listener instance of class [org.springframework.web.context.ContextLoaderListener]
java.lang.AbstractMethodError: Receiver class ch.qos.logback.classic.Logger does not define or inherit an implementation of the resolved method &apos;abstract void log(org.slf4j.Marker, java.lang.String, int, java.lang.String, java.lang.Throwable)&apos; of interface org.slf4j.spi.LocationAwareLogger.
       at org.apache.commons.logging.impl.SLF4JLocationAwareLog.info(SLF4JLocationAwareLog.java:159)
       at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:187)
       at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:47)
       at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4643)
       at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5109)
       at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
       at org.apache.catalina.manager.ManagerServlet.start(ManagerServlet.java:1395)
       at org.apache.catalina.manager.HTMLManagerServlet.start(HTMLManagerServlet.java:698)
       at org.apache.catalina.manager.HTMLManagerServlet.doPost(HTMLManagerServlet.java:223)
       at javax.servlet.http.HttpServlet.service(HttpServlet.java:660)
       at javax.servlet.http.HttpServlet.service(HttpServlet.java:741)
       at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)
</code></pre><h3 id="Reason"><a href="#Reason" class="headerlink" title="Reason"></a>Reason</h3><p>If log4j-over-slf4j.jar and slf4j-log4j12.jar exist on the same classpath, the problem arise.      </p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p><strong>Manual test</strong><br>delete log4j-over-slf4j-1.7.5.jar on WEB-INF/lib folder and restart Tomcat 8.</p>
<p><strong>Remove it from pom.xml</strong> </p>
<p>Find transitive dependency in pom:</p>
<pre><code>mvn dependency:tree
</code></pre><p>The output looks like:</p>
<pre><code>[INFO] +- javax.servlet:servlet-api:jar:2.4:compile
[INFO] +- javax.faces:jsf-api:jar:1.2_04:provided
[INFO] +- javax.faces:jsf-impl:jar:1.2_04:provided
[INFO] +- commons-beanutils:commons-beanutils:jar:1.7.0:compile
[INFO] +- commons-digester:commons-digester:jar:1.8:compile
[INFO] +- commons-logging:commons-logging:jar:1.1.1:compile
[INFO] +- commons-logging:commons-logging-api:jar:1.1:compile
[INFO] +- junit:junit:jar:4.7:test
[INFO] +- log4j:log4j:jar:1.2.15:compile
[INFO] |  +- javax.jms:jms:jar:1.1:compile
[INFO] |  \- com.sun.jmx:jmxri:jar:1.2.1:compile
[INFO] +- taglibs:standard:jar:1.1.2:compile
[INFO] +- org.apache.tiles:tiles-api:jar:2.1.4:compile
[INFO] +- org.apache.tiles:tiles-core:jar:2.1.4:compile
[INFO] +- org.apache.tiles:tiles-jsp:jar:2.1.4:compile
[INFO] |  \- org.apache.tiles:tiles-servlet:jar:2.1.4:compile
[INFO] +- com.sun.jdmk:jmxtools:jar:1.2.1:compile
[INFO] +- org.apache.solr:solr-solrj:jar:3.6.2:compile
[INFO] |  +- commons-httpclient:commons-httpclient:jar:3.1:compile
[INFO] |  \- org.codehaus.woodstox:wstx-asl:jar:3.2.7:runtime
[INFO] +- org.slf4j:slf4j-api:jar:1.5.11:compile
[INFO] +- org.slf4j:slf4j-log4j12:jar:1.5.11:compile
[INFO] +- org.slf4j:jcl-over-slf4j:jar:1.5.11:compile
[INFO] +- javax.servlet:jstl:jar:1.2:compile
[INFO] +- org.jvnet.ws.wadl:wadl-core:jar:1.0-SNAPSHOT-NT:compile
[INFO] +- javax.xml.bind:jaxb-api:jar:2.3.1:compile
[INFO] |  \- javax.activation:javax.activation-api:jar:1.2.0:compile
[INFO] +- javax.activation:activation:jar:1.1:compile
[INFO] +- org.glassfish.jaxb:jaxb-runtime:jar:2.3.1:compile
[INFO] |  +- org.glassfish.jaxb:txw2:jar:2.3.1:compile
[INFO] |  +- com.sun.istack:istack-commons-runtime:jar:3.0.7:compile
[INFO] |  +- org.jvnet.staxex:stax-ex:jar:1.8:compile
[INFO] |  \- com.sun.xml.fastinfoset:FastInfoset:jar:1.2.15:compile
[INFO] +- javax.ws.rs:jsr311-api:jar:1.1.1:compile
[INFO] +- com.sun.jersey:jersey-core:jar:1.3:compile
[INFO] +- com.sun.jersey:jersey-client:jar:1.3:compile
[INFO] +- com.sun.jersey.contribs:jersey-spring:jar:1.3:compile
[INFO] +- xalan:xalan:jar:2.7.1:compile
[INFO] |  \- xalan:serializer:jar:2.7.1:compile
[INFO] +- com.sun.jersey:jersey-server:jar:1.3:compile
[INFO] |  \- asm:asm:jar:3.1:compile
[INFO] +- org.springframework:spring-mock:jar:2.0.8:test
[INFO] +- org.springframework:spring-test:jar:3.0.5.RELEASE:test
[INFO] +- org.springframework:spring-web:jar:3.0.5.RELEASE:compile
[INFO] |  \- aopalliance:aopalliance:jar:1.0:compile
[INFO] +- org.springframework:spring-webmvc:jar:3.0.5.RELEASE:compile
[INFO] |  +- org.springframework:spring-asm:jar:3.0.5.RELEASE:compile
[INFO] |  \- org.springframework:spring-context-support:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework:spring-beans:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework:spring-context:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework:spring-core:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework:spring-expression:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework.security:spring-security-web:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework.security:spring-security-config:jar:3.0.5.RELEASE:compile
[INFO] +- org.springframework.security:spring-security-taglibs:jar:3.0.5.RELEASE:compile
[INFO] |  \- org.springframework.security:spring-security-acl:jar:3.0.5.RELEASE:compile
[INFO] |     \- org.springframework:spring-jdbc:jar:3.0.3.RELEASE:compile
[INFO] +- org.springframework:spring-aop:jar:3.0.5.RELEASE:compile
[INFO] +- cglib:cglib:jar:2.2:compile
[INFO] +- org.aspectj:aspectjweaver:jar:1.6.11:compile
[INFO] +- com.yourmediashelf.fedora.client:fedora-client-core:jar:0.8s:compile
[INFO] |  +- com.sun.jersey.contribs:jersey-multipart:jar:1.17.1:compile
[INFO] |  |  \- org.jvnet:mimepull:jar:1.6:compile
[INFO] |  +- com.hp.hpl.jena:jena:jar:2.6.4:compile
[INFO] |  |  +- com.hp.hpl.jena:iri:jar:0.8:compile
[INFO] |  |  \- com.ibm.icu:icu4j:jar:3.4.4:compile
[INFO] |  +- org.apache.santuario:xmlsec:jar:1.5.4:compile
[INFO] |  +- org.slf4j:log4j-over-slf4j:jar:1.7.5:runtime
[INFO] |  \- xerces:xercesImpl:jar:2.11.0:compile
[INFO] +- org.openrdf:openrdf-sesame:jar:onejar:2.3.2:compile
[INFO] +- taglibs:string:jar:1.1.0:compile
[INFO] +- org.apache.commons:commons-lang3:jar:3.4:compile
[INFO] +- rome:rome-fetcher:jar:1.0:compile
[INFO] |  +- jdom:jdom:jar:1.0:compile
[INFO] |  \- rome:rome:jar:1.0:compile
[INFO] +- orbeon:xforms-filter:jar:3.9:compile
[INFO] +- com.jspsmart:upload:jar:1.0:compile
[INFO] +- commons-fileupload:commons-fileupload:jar:1.2.2:compile
[INFO] +- commons-io:commons-io:jar:2.0.1:compile
[INFO] +- dom4j:dom4j:jar:1.6.1:compile
[INFO] |  \- xml-apis:xml-apis:jar:1.0.b2:compile
[INFO] +- jaxen:jaxen:jar:1.1.1:compile
[INFO] |  \- xom:xom:jar:1.0:compile
[INFO] |     \- xerces:xmlParserAPIs:jar:2.6.2:compile
[INFO] +- org.apache.commons:commons-compress:jar:1.0:compile
[INFO] +- javax.mail:mail:jar:1.4.5:compile
[INFO] +- org.apache.commons:commons-email:jar:1.2:compile
[INFO] +- org.freemarker:freemarker:jar:2.3.19:compile
[INFO] +- displaytag:displaytag:jar:1.2:compile
[INFO] |  +- commons-collections:commons-collections:jar:3.1:compile
[INFO] |  +- commons-lang:commons-lang:jar:2.3:compile
[INFO] |  \- com.lowagie:itext:jar:1.3:compile
[INFO] +- jcs:jcs:jar:1.3:compile
[INFO] |  +- commons-configuration:commons-configuration:jar:1.4:compile
[INFO] |  |  +- commons-beanutils:commons-beanutils-core:jar:1.7.0:compile
[INFO] |  |  \- commons-jxpath:commons-jxpath:jar:1.2:compile
[INFO] |  |     \- ant:ant-optional:jar:1.5.1:compile
[INFO] |  +- commons-dbcp:commons-dbcp:jar:1.2.2:compile
[INFO] |  +- commons-pool:commons-pool:jar:1.3:compile
[INFO] |  +- concurrent:concurrent:jar:1.0:compile
[INFO] |  +- mysql:mysql-connector-java:jar:3.0.10:compile
[INFO] |  |  +- javax.sql:jdbc-stdext:jar:2.0:compile
[INFO] |  |  \- javax.transaction:jta:jar:1.0.1B:compile
[INFO] |  +- hsqldb:hsqldb:jar:1.7.3.3:compile
[INFO] |  +- tomcat:tomcat-util:jar:3.2.1:compile
[INFO] |  +- velocity:velocity:jar:1.5:compile
[INFO] |  |  \- oro:oro:jar:2.0.8:compile
[INFO] |  +- xmlrpc:xmlrpc:jar:2.0:compile
[INFO] |  \- berkeleydb:berkeleydb:jar:1.5.1:compile
[INFO] +- net.sf.ehcache:ehcache:jar:2.4.2:compile
[INFO] |  +- net.sf.ehcache:ehcache-core:jar:2.4.2:compile
[INFO] |  \- net.sf.ehcache:ehcache-terracotta:jar:2.4.2:compile
[INFO] +- org.codehaus.jackson:jackson-mapper-lgpl:jar:1.5.6:compile
[INFO] |  \- org.codehaus.jackson:jackson-core-lgpl:jar:1.5.6:compile
[INFO] +- org.apache.httpcomponents:httpclient:jar:4.3.6:compile
[INFO] |  \- commons-codec:commons-codec:jar:1.6:compile
[INFO] +- org.apache.httpcomponents:httpcore:jar:4.3.3:compile
[INFO] +- eu.medsea.mimeutil:mime-util:jar:2.1.3:compile
[INFO] +- joda-time:joda-time:jar:1.6.1:compile
[INFO] +- org.apache.oltu.oauth2:org.apache.oltu.oauth2.client:jar:1.0.1-SNAPSHOT:compile
[INFO] +- org.apache.oltu.oauth2:org.apache.oltu.oauth2.common:jar:1.0.1-SNAPSHOT:compile
[INFO] +- org.json:json:jar:20140107:compile
[INFO] +- org.springframework.security.oauth:spring-security-oauth2:jar:1.0.5.RELEASE:compile
[INFO] |  \- org.codehaus.jackson:jackson-mapper-asl:jar:1.9.2:compile
[INFO] |     \- org.codehaus.jackson:jackson-core-asl:jar:1.9.2:compile
[INFO] \- org.springframework.security:spring-security-core:jar:3.0.5.RELEASE:compile
[INFO]    +- org.springframework:spring-tx:jar:3.0.3.RELEASE:compile
[INFO]    \- org.aspectj:aspectjrt:jar:1.6.8:compile        
</code></pre><p>Do a text search of ‘log4j-over-slf4j’ on the above result, and it shows that the com.yourmediashelf.fedora.client:fedora-client-core:jar has a transitive dependency on log4j-over-slf4j. </p>
<p>In the pom.xml, change:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.yourmediashelf.fedora.client&lt;/groupId&gt;
    &lt;artifactId&gt;fedora-client-core&lt;/artifactId&gt;
    &lt;version&gt;0.8s&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>to:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.yourmediashelf.fedora.client&lt;/groupId&gt;
    &lt;artifactId&gt;fedora-client-core&lt;/artifactId&gt;
    &lt;version&gt;0.8s&lt;/version&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;
</code></pre><h2 id="JSTL-problem"><a href="#JSTL-problem" class="headerlink" title="JSTL problem"></a>JSTL problem</h2><p>While loading details page, an error message is showing in the Tomcat log:</p>
<pre><code>[Fatal Error] jstl::1:1: Content is not allowed in prolog.
</code></pre><h3 id="Reason-amp-fix"><a href="#Reason-amp-fix" class="headerlink" title="Reason &amp; fix"></a>Reason &amp; fix</h3><p>The feedbackXML has been’t generated properly if there is no FEEDBACK data stream. In AbstractResourceController.java, line 669:</p>
<pre><code>try{
    XXXXXXX
}catch(Exception e) {
    XXXXXXX
}finally {
&gt;&gt;&gt;&gt;    if(feedbackiris!=null)
        XXXXXX
    else
        XXXXXX
}
</code></pre><p>It should be changed to:</p>
<pre><code>if(feedbackiris!=null &amp;&amp; feedbackiris.startsWith(&quot;&lt;?xml version=&quot;))             
</code></pre><h2 id="IP-restrictions"><a href="#IP-restrictions" class="headerlink" title="IP restrictions"></a>IP restrictions</h2><p>Edit /etc/apache2/sites-enabled/default-ssl.conf, add the following:</p>
<pre><code>&lt;Location /solr&gt;
  Allow from TEST_SERVER_IP                     
  ...
&lt;/Location&gt;  

&lt;Location /fedora/risearch&gt;  
  Allow from TEST_SERVER_IP                     
  ...
&lt;/Location&gt;

&lt;Directory &quot;/usr/digilib-webdocs/digilibImages&quot;&gt;
  Allow from dlibjavatest0.york.ac.uk
  ...
&lt;/Directory&gt;
</code></pre><p>Restart Apache2</p>
<pre><code>service apache2 restart
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/iris-migration/" data-id="ck3ekt7s40000c2054mykml83" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fedora/">Fedora</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solr/">Solr</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ruby-tips" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/ruby-tips/" class="article-date">
  <time datetime="2019-12-05T11:12:51.114Z" itemprop="datePublished">2019-12-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ruby-tips/">Ruby tips</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Language-basics"><a href="#Language-basics" class="headerlink" title="Language basics"></a>Language basics</h2><h3 id=""><a href="#" class="headerlink" title="||="></a>||=</h3><pre><code>x ||= y 
</code></pre><p>means </p>
<pre><code>x || x = y 
</code></pre><p>so if x is nil or false set x to be the value of y.</p>
<h2 id="Class-attributes"><a href="#Class-attributes" class="headerlink" title="Class attributes"></a>Class attributes</h2><p>Use of attribute readers (public/private)</p>
<pre><code>attr_reader :names
def initialize(names)
    @names = names
end
</code></pre><p>Then @names can be accessed via ‘names’</p>
<pre><code>def latest
    names.last
end
</code></pre><h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><pre><code>String.lines
</code></pre><p>Check if a string starts with any string from an array:</p>
<pre><code>prefixes=[&apos;Dr&apos;,&apos;Mr&apos;,&apos;Miss&apos;,&apos;Mrs&apos;]
&apos;Tom Smith&apos;.starts_with?(*prefixes)
=&gt; false
&apos;Mr Tom Smith&apos;.starts_with?(*prefixes)
=&gt; true        
</code></pre><h2 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h2><h3 id="Swap-array-rows-with-columns"><a href="#Swap-array-rows-with-columns" class="headerlink" title="Swap array rows with columns"></a>Swap array rows with columns</h3><pre><code>Array.transpose()
</code></pre><p>e.g.<br>    matrix_string = “1 2 3\n4 5 6\n7 8 9”<br>    @rows = matrix_string.lines.collect{|x| x.split.collect{|y| y.to_i}}<br>    @columns = @rows.transpose()    </p>
<h3 id="Remove-duplicate-elements-from-array"><a href="#Remove-duplicate-elements-from-array" class="headerlink" title="Remove duplicate elements from array"></a>Remove duplicate elements from array</h3><pre><code>array_name.uniq
</code></pre><p>OR use the following to operate on the same array</p>
<pre><code>array_name.uniq!
</code></pre><h3 id="each-cons"><a href="#each-cons" class="headerlink" title="each_cons"></a>each_cons</h3><pre><code>irb(main):001:0&gt; s = &quot;123456789&quot;
=&gt; &quot;123456789&quot;

irb(main):002:0&gt; s.chars
=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;]

irb(main):003:0&gt; s.chars.each_cons(2).to_a
=&gt; [[&quot;1&quot;, &quot;2&quot;], [&quot;2&quot;, &quot;3&quot;], [&quot;3&quot;, &quot;4&quot;], [&quot;4&quot;, &quot;5&quot;], [&quot;5&quot;, &quot;6&quot;], [&quot;6&quot;, &quot;7&quot;], [&quot;7&quot;, &quot;8&quot;], [&quot;8&quot;, &quot;9&quot;]]

irb(main):004:0&gt; s.chars.each_cons(2).to_a.collect {|a| a.join}
=&gt; [&quot;12&quot;, &quot;23&quot;, &quot;34&quot;, &quot;45&quot;, &quot;56&quot;, &quot;67&quot;, &quot;78&quot;, &quot;89&quot;]    
</code></pre><p>The above expression can be simplified:</p>
<pre><code>irb(main):004:0&gt; s.chars.each_cons(2).collect(&amp;:join)
=&gt; [&quot;12&quot;, &quot;23&quot;, &quot;34&quot;, &quot;45&quot;, &quot;56&quot;, &quot;67&quot;, &quot;78&quot;, &quot;89&quot;]    
</code></pre><h3 id="zip-amp-count"><a href="#zip-amp-count" class="headerlink" title="zip &amp; count"></a>zip &amp; count</h3><pre><code>strand1 = &apos;AAAB&apos;
strand2 = &apos;AAAC&apos;
strand1.chars.zip(strand2.chars).count {|n1, n2| n1 != n2}  
</code></pre><h2 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h2><p>Lots of internal methods can be used in collections, e.g.</p>
<pre><code>scores.last
scores.max
scores.min
scores.sort
soores.reverse
</code></pre><h3 id="Enumerable"><a href="#Enumerable" class="headerlink" title="Enumerable"></a>Enumerable</h3><pre><code>s = &quot;aa bb cc dd ee ff gg aa&quot;

s.scan(/\w+(?:&apos;\w+)*/)
=&gt; [&quot;aa&quot;, &quot;bb&quot;, &quot;cc&quot;, &quot;dd&quot;, &quot;ee&quot;, &quot;ff&quot;, &quot;gg&quot;, &quot;aa&quot;]

s.scan(/\w+(?:&apos;\w+)*/).group_by(&amp;:itself)
=&gt; {&quot;aa&quot;=&gt;[&quot;aa&quot;, &quot;aa&quot;], &quot;bb&quot;=&gt;[&quot;bb&quot;], &quot;cc&quot;=&gt;[&quot;cc&quot;], &quot;dd&quot;=&gt;[&quot;dd&quot;], &quot;ee&quot;=&gt;[&quot;ee&quot;], &quot;ff&quot;=&gt;[&quot;ff&quot;], &quot;gg&quot;=&gt;[&quot;gg&quot;]}

s.scan(/\w+(?:&apos;\w+)*/).group_by(&amp;:itself).transform_values{|x| x.length}
=&gt; {&quot;aa&quot;=&gt;2, &quot;bb&quot;=&gt;1, &quot;cc&quot;=&gt;1, &quot;dd&quot;=&gt;1, &quot;ee&quot;=&gt;1, &quot;ff&quot;=&gt;1, &quot;gg&quot;=&gt;1}
</code></pre><p><strong>each_with_object</strong> method gives a way to iterate an Enumerable and doing some process within the loop.<br>    drop = 15<br>    drops = {<br>          3  =&gt; ‘Pling’,<br>          5  =&gt; ‘Plang’,<br>          7  =&gt; ‘Plong’<br>    }<br>    sounds = drops.each_with_object(‘’) { |(factor, note), sound| sound &lt;&lt; note if (drop % factor).zero? }</p>
<h2 id="Regular-expressions"><a href="#Regular-expressions" class="headerlink" title="Regular expressions"></a>Regular expressions</h2><h3 id="acronyms"><a href="#acronyms" class="headerlink" title="acronyms"></a>acronyms</h3><p>Question: convert a sentence to its acronym, e.g.</p>
<pre><code>Portable Network Graphics &gt; PNG
Ruby on Rails &gt; ROR
First In, First Out &gt; FIFO
Something - I made up from thin air &gt; SIMUFTA        
</code></pre><p>The easy solution is to use RE:</p>
<pre><code>def self.abbreviate(phrase)
    phrase.scan(/\b\w/).join.upcase
end
</code></pre><p>Scan with the regex /\b\w/ will catch ‘word boundaries’ (space, - and more) followed by a word character. This means that scan(/\b\w/) returns an array with the first letters only.    </p>
<h3 id="Word-counts"><a href="#Word-counts" class="headerlink" title="Word counts"></a>Word counts</h3><pre><code>class Phrase
  attr_reader :phrase

  def initialize(phrase)
    @phrase = phrase
  end

  def word_count
    counts = Hash.new(0)
    phrase.downcase.scan(/\w+(?:&apos;\w+)*/).each { |w| counts[w] += 1 }
    counts
  end
end  
</code></pre><ul>
<li>\w+ - 1 or more word chars</li>
<li><p>(?:’\w+)<em> - zero or more sequences (as (?:…)</em> is a non-capturing group that groups a sequence of subpatterns quantified with * quantifier matching 0 or more occurrences) of:</p>
<ul>
<li>‘ - apostrophe</li>
<li><p>\w+ - 1 or more word chars.</p>
<p>phrase = “Joe can’t tell between ‘large’ and large.”<br>phrase.downcase.scan(/\w+(?:’\w+)*/).each { |w| counts[w] += 1 }</p>
<blockquote>
<blockquote>
</blockquote>
<p>{“joe”=&gt;1, “can’t”=&gt;1, “tell”=&gt;1, “between”=&gt;1, “large”=&gt;2, “and”=&gt;1}</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><strong>Iteration 2</strong>: to remove the temporary variable</p>
<pre><code>phrase.downcase.scan(/\w+(?:&apos;\w+)*/).group_by{|e| e}.map{|k, v| [k, v.length]}.to_h
</code></pre><p><strong>Iteration 3</strong>: think about SRP and remove intermediate array generated by map</p>
<pre><code>def words
    phrase.downcase.scan(/\w+(?:&apos;\w+)*/)
end

def word_count
    #words.group_by(&amp;:itself).transform_values{|x| x.length}
    words.group_by(&amp;:itself).transform_values(&amp;:length)
end     
</code></pre><h2 id="Error-handling"><a href="#Error-handling" class="headerlink" title="Error handling"></a>Error handling</h2><h3 id="Subclassing-a-standard-Error-class"><a href="#Subclassing-a-standard-Error-class" class="headerlink" title="Subclassing a standard Error class"></a>Subclassing a standard Error class</h3><pre><code>class StrandLengthsError &lt; ArgumentError
  attr_reader :object

  def initialize(message = &apos;Strand lengths must be identical.&apos;, object)
    super(message)
    @object = object
  end
end
</code></pre><h2 id="Code-style-conventions"><a href="#Code-style-conventions" class="headerlink" title="Code style conventions"></a>Code style conventions</h2><h3 id="Indentation"><a href="#Indentation" class="headerlink" title="Indentation"></a>Indentation</h3><p>The indentation for Ruby programs should be 2 spaces.</p>
<h3 id="Spaces"><a href="#Spaces" class="headerlink" title="Spaces"></a>Spaces</h3><p>The ones with space around are:</p>
<pre><code>=
==
!= &lt;---
-
+
*
%
</code></pre><p>The / method sometimes with space around and sometimes not:</p>
<ul>
<li>No space when communication “fraction”</li>
<li>Space around when communicating “division”</li>
</ul>
<p>No Space for ** method, as it mirrors how people write on paper, such as $x^y$.    </p>
<h3 id="Ruby-class-structure"><a href="#Ruby-class-structure" class="headerlink" title="Ruby class structure"></a>Ruby class structure</h3><pre><code>class Class XX

  # class methods

  private

  # constructors

  # attribute readers

  # private methods

  public

  # public methods

end
</code></pre><h3 id="defined-by-proximity"><a href="#defined-by-proximity" class="headerlink" title="defined by proximity"></a>defined by proximity</h3><pre><code>def distance
  nucleotides.count { |n1, n2| n1 != n2 }
end
</code></pre><p>From above code, it’s very easy to understand what ‘n1’ and ‘n2’ mean.</p>
<h3 id="Variable-names"><a href="#Variable-names" class="headerlink" title="Variable names"></a>Variable names</h3><p>If we are talking about programming languages and what each with object does, we<br> might use k and v since those are speaking to the key and value positions,<br> and are “commonly known” to the problem domain of programming languages.<br> But programming language <strong>isn’t the problem being solved in all situations</strong>,<br> so perhaps factor and note and sound makes sense for the argument list in that block in the raindrop program. </p>
<h3 id="Line-length"><a href="#Line-length" class="headerlink" title="Line length"></a>Line length</h3><p>Rubocop suggests that a single line should not longer than 80 columns.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/ruby-tips/" data-id="cjzxw1akv0001bh05yr23udlh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rails-page-only-working-after-refresh" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/rails-page-only-working-after-refresh/" class="article-date">
  <time datetime="2019-11-15T12:40:12.000Z" itemprop="datePublished">2019-11-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/rails-page-only-working-after-refresh/">Rails page only working after refresh?</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h2><p>Some Rails pages are not working properly, e.g. the JavaScript code stops working. However, after a refresh, it’s working again.</p>
<p>Sounds familiar?</p>
<p>Actually, to be more accurate, the problem happens if:</p>
<p>You click a link in your Rails application and it takes you to another page, still within the same domain. The JS stops working.</p>
<p>However, if you copy the second page URL and paste it to the URL address bar, it works. </p>
<h2 id="Reason"><a href="#Reason" class="headerlink" title="Reason"></a>Reason</h2><p>It’s the compatibility problem between turbolinks and jQuery. Basically, turbolinks optimized the links within the application and only partially load the target page elements and combine it with current page. Sometimes it’s noting working.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Prior to Rails before 2013, you can use a gem called jquery-turbolinks which will resolve this problem for you. </p>
<p>However, with the latest Rails (5.x+), the gem won’t work.</p>
<p>The workaround is to monitor the appropriate event, e.g. </p>
<p>Change</p>
<pre><code>$(function() {
</code></pre><p>To:</p>
<pre><code>$(document).on(&apos;turbolinks:load&apos;, function() {
</code></pre><p>It should just works.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://github.com/onokumus/metismenu/issues/121" target="_blank" rel="noopener">https://github.com/onokumus/metismenu/issues/121</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/rails-page-only-working-after-refresh/" data-id="ck30a6m1k0000us05zn13snib" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/turbolinks/">turbolinks</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hyrax-content-blocks" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/hyrax-content-blocks/" class="article-date">
  <time datetime="2019-10-29T12:40:12.000Z" itemprop="datePublished">2019-10-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hyrax/">hyrax</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/hyrax-content-blocks/">How does Hyrax content blocks work?</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>To add a new content block page, you need to follow steps below:</p>
<h2 id="Register-a-new-content-block-in-models"><a href="#Register-a-new-content-block-in-models" class="headerlink" title="Register a new content block in models"></a>Register a new content block in models</h2><p>app/models/content_block.rb</p>
<pre><code>def help_page
  find_by(name: &apos;help_page&apos;) ||
    create(name: &apos;help_page&apos;, value: default_help_text)
end
</code></pre><p>and</p>
<pre><code>def default_help_text
  ERB.new(
    IO.read(
        Rails.root.join(&apos;app&apos;, &apos;views&apos;, &apos;hyrax&apos;, &apos;content_blocks&apos;, &apos;templates&apos;, &apos;help.html.erb&apos;)
    )
  ).result
end
</code></pre><h2 id="Template-file"><a href="#Template-file" class="headerlink" title="Template file"></a>Template file</h2><p>app/views/hyrax/content_blocks/templates</p>
<p>just add any HTML you like to the template file, e.g. help.html.erb</p>
<p>Still Not showing the new page content?</p>
<p>You need to delete the record in the database ‘content_blocks’ table</p>
<h2 id="Add-a-new-content-block-tab-in-Admin-page"><a href="#Add-a-new-content-block-tab-in-Admin-page" class="headerlink" title="Add a new content block tab in Admin page"></a>Add a new content block tab in Admin page</h2><p>app/views/hyrax/content_blocks/_form.html.erb</p>
<p>On the top, add:</p>
<pre><code>&lt;li&gt;
  &lt;a href=&quot;#help&quot; role=&quot;tab&quot; data-toggle=&quot;tab&quot; class=&quot;nav-safety-confirm&quot;&gt;&lt;%= t(:&apos;hyrax.content_blocks.tabs.help&apos;) %&gt;&lt;/a&gt;
&lt;/li&gt;
</code></pre><p>On the bottom, add:</p>
<pre><code>&lt;div id=&quot;help&quot; class=&quot;tab-pane&quot;&gt;
  &lt;div class=&quot;panel panel-default labels&quot;&gt;
    &lt;%= simple_form_for ContentBlock.for(:help), url: hyrax.content_block_path(ContentBlock.for(:help)), html: {class: &apos;nav-safety&apos;} do |f| %&gt;
      &lt;div class=&quot;panel-body&quot;&gt;
        &lt;div class=&quot;field form-group&quot;&gt;
          &lt;%= f.label :help %&gt;&lt;br /&gt;
          &lt;%= f.text_area :help, value: f.object.value, class: &apos;form-control tinymce&apos;, rows: 20, cols: 120 %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;panel-footer&quot;&gt;
        &lt;%= link_to t(:&apos;hyrax.content_blocks.cancel&apos;), hyrax.admin_admin_sets_path, class: &apos;btn btn-default pull-right&apos; %&gt;
        &lt;%= f.button :submit, class: &apos;btn btn-primary pull-right&apos; %&gt;
      &lt;/div&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre><h2 id="Content-block-controller"><a href="#Content-block-controller" class="headerlink" title="Content block controller"></a>Content block controller</h2><p>Copy content_blocks_controller.rb from app/controllers/hyrax to NCELP and update the following:</p>
<pre><code>params.require(:content_block).permit(:marketing,
                                      :announcement,
                                      :researcher,
                                      :help)
</code></pre><h2 id="Update-locale-file"><a href="#Update-locale-file" class="headerlink" title="Update locale file"></a>Update locale file</h2><p>Edit config/locales/hyrax.en.yml, and add:</p>
<pre><code>hyrax:
  content_blocks:
    help: Help
</code></pre><h2 id="Add-a-menu-in-the-menubar"><a href="#Add-a-menu-in-the-menubar" class="headerlink" title="Add a menu in the menubar"></a>Add a menu in the menubar</h2><p>Edit app/views/_controls.html.erb, and add:</p>
<pre><code>&lt;li &lt;%= &apos;class=active&apos; if current_page?(hyrax.about_path) %&gt;&gt;
    &lt;%= link_to t(:&apos;hyrax.controls.about&apos;), hyrax.about_path, aria: current_page?(hyrax.about_path) ? {current: &apos;page&apos;} : nil %&gt;&lt;/li&gt;   
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/hyrax-content-blocks/" data-id="ck2byutc60000vz05lqcmuka4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/content-blocks/">content blocks</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hyrax/">hyrax</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/samvera/">samvera</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-disable-download-notification-for-a-user" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/how-to-disable-download-notification-for-a-user/" class="article-date">
  <time datetime="2019-10-08T21:40:12.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/how-to-disable-download-notification-for-a-user/">How to disable download notifications to authors in IRIS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The following steps mainly for IRIS admins who left IRIS team, but the email notifications are still triggered. Tons of undelivered email may result in the suspension of the IRIS admin email account.</p>
<p>1) Open yodl.properties file, and find object PID, e.g. with key iris.userMappings.</p>
<p>2) Open the fedora object in Fedora admin web UI.</p>
<p>3) Find matched ownerid for a particular email from UserMapping datastream.</p>
<p>4) Run the following RI query to find user’s profile object id:</p>
<pre><code>select $object
from &lt;#ri&gt;
where $object &lt;fedora-model:hasModel&gt; &lt;fedora:york:CModel-User&gt;
and $object &lt;info:fedora/fedora-system:def/model#ownerId&gt; &apos;THE_ABOVE_OWNERID&apos;
order by $object
</code></pre><p>5) Open user profile object in Fedora Web UI and open User datastream.</p>
<p>6) Change notifyDownloads to ‘false’</p>
<pre><code>&lt;notifyDownloads&gt;false&lt;/notifyDownloads&gt;
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/how-to-disable-download-notification-for-a-user/" data-id="ck1j33wqw00004405jczltdl2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IRIS/">IRIS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/notification/">notification</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ruby-aws-lambda" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/ruby-aws-lambda/" class="article-date">
  <time datetime="2019-10-03T21:40:12.000Z" itemprop="datePublished">2019-10-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ruby-aws-lambda/">Develop an AWS Lambda with Ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Install-jets-and-create-project"><a href="#Install-jets-and-create-project" class="headerlink" title="Install jets and create project"></a>Install jets and create project</h2><pre><code>gem install jets
jets new dad-jokes-sms --mode api --no-database
jets serve --host 0.0.0.0
</code></pre><p>Then try to access the app from localhost:8888</p>
<pre><code>jets generate controller Messages create
</code></pre><h2 id="Implement-the-application-in-the-local-environment"><a href="#Implement-the-application-in-the-local-environment" class="headerlink" title="Implement the application in the local environment"></a>Implement the application in the local environment</h2><p>Edit config/routes.rb</p>
<pre><code>post &apos;messages&apos;, to: &apos;messages#create&apos;
root &quot;jets/public#show&quot;
</code></pre><p>Replace message_controller.rb with following:</p>
<pre><code>require &apos;open-uri&apos;

class MessagesController &lt; ApplicationController
 def create
   twiml = Twilio::TwiML::MessagingResponse.new
   twiml.message body: random_joke
   render xml: twiml.to_xml
 end

 private
   def random_joke
     open(&apos;https://icanhazdadjoke.com/&apos;, { &apos;Accept&apos; =&gt; &apos;text/plain&apos; }).read
   end
end
</code></pre><p>Add following to Gemfile:</p>
<pre><code>gem &quot;jets&quot;
gem &quot;twilio-ruby&quot;
</code></pre><p>Run:</p>
<pre><code>bundle install
</code></pre><p>Restart Jets and run:</p>
<pre><code>curl --data &quot;&quot; http://localhost:8888/messages
</code></pre><h2 id="AWS-setup"><a href="#AWS-setup" class="headerlink" title="AWS setup"></a>AWS setup</h2><p>In AWS IAM, create a policy, choose “json” and paste the following:</p>
<pre><code>{
 &quot;Version&quot;: &quot;2012-10-17&quot;,
 &quot;Statement&quot;: [
 {
 &quot;Effect&quot;: &quot;Allow&quot;,
 &quot;Action&quot;: [
 &quot;apigateway:*&quot;,
 &quot;cloudformation:*&quot;,
 &quot;dynamodb:*&quot;,
 &quot;events:*&quot;,
 &quot;iam:*&quot;,
 &quot;lambda:*&quot;,
 &quot;logs:*&quot;,
 &quot;route53:*&quot;,
 &quot;s3:*&quot;
 ],
 &quot;Resource&quot;: [
 &quot;*&quot;
 ]
 }
 ]
}
</code></pre><p>Add name/desc and click “Create”.</p>
<p>Create a user: jets-user<br>With this option: Programmatic access</p>
<p>Attach jets-policy to jets-user</p>
<p>Then you will have the access key and secret. </p>
<h2 id="Deploy-it-to-AWS"><a href="#Deploy-it-to-AWS" class="headerlink" title="Deploy it to AWS"></a>Deploy it to AWS</h2><p>Run the following command:</p>
<pre><code>AWS_ACCESS_KEY_ID=XXXXXX AWS_SECRET_ACCESS_KEY=XXXXXX jets deploy
</code></pre><p><strong>If you have a problem complaining about jsych, try to add it into Gemfile and bundle install.</strong></p>
<p>If successful, you should see something like:</p>
<pre><code>Uploading s3://dad-jokes-sms-dev-s3bucket-1iez1o87ck0t0/jets/public/index.html
Uploading s3://dad-jokes-sms-dev-s3bucket-1iez1o87ck0t0/jets/public/422.html
Uploading s3://dad-jokes-sms-dev-s3bucket-1iez1o87ck0t0/jets/public/404.html
Time for public assets to s3: 0s
Deploying CloudFormation stack with jets app!
10:20:57AM UPDATE_IN_PROGRESS AWS::CloudFormation::Stack dad-jokes-sms-dev User Initiated
10:20:59AM CREATE_IN_PROGRESS AWS::Lambda::LayerVersion GemLayer 
10:20:59AM CREATE_IN_PROGRESS AWS::IAM::Role IamRole 
10:20:59AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiGateway 
10:21:00AM CREATE_IN_PROGRESS AWS::IAM::Role IamRole Resource creation Initiated
10:21:00AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiGateway Resource creation Initiated
10:21:11AM CREATE_COMPLETE AWS::CloudFormation::Stack ApiGateway 
10:21:11AM CREATE_COMPLETE AWS::IAM::Role IamRole 
10:21:12AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiResources1 
10:21:12AM CREATE_IN_PROGRESS AWS::Lambda::LayerVersion GemLayer Resource creation Initiated
10:21:12AM CREATE_COMPLETE AWS::Lambda::LayerVersion GemLayer 
10:21:13AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiResources1 Resource creation Initiated
10:21:14AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack JetsPreheatJob 
10:21:15AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack JetsPreheatJob Resource creation Initiated
10:21:23AM CREATE_COMPLETE AWS::CloudFormation::Stack ApiResources1 
10:21:25AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack JetsPublicController 
10:21:25AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack MessagesController 
10:21:25AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack JetsPublicController Resource creation Initiated
10:21:26AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack MessagesController Resource creation Initiated
10:21:47AM CREATE_COMPLETE AWS::CloudFormation::Stack JetsPublicController 
10:21:47AM CREATE_COMPLETE AWS::CloudFormation::Stack MessagesController 
10:21:49AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiDeployment20190926102055 
10:21:50AM CREATE_IN_PROGRESS AWS::CloudFormation::Stack ApiDeployment20190926102055 Resource creation Initiated
10:22:00AM CREATE_COMPLETE AWS::CloudFormation::Stack ApiDeployment20190926102055 
10:22:49AM CREATE_COMPLETE AWS::CloudFormation::Stack JetsPreheatJob 
10:22:50AM UPDATE_COMPLETE_CLEANUP_IN_PROGRESS AWS::CloudFormation::Stack dad-jokes-sms-dev 
10:22:51AM UPDATE_COMPLETE AWS::CloudFormation::Stack dad-jokes-sms-dev 
Stack success status: UPDATE_COMPLETE
Time took for stack deployment: 1m 58s.
Prewarming application.
API Gateway Endpoint: https://XXXXXXXX.execute-api.eu-west-2.amazonaws.com/dev/
</code></pre><p>Test it with curl:</p>
<pre><code>curl --data &quot;&quot; https://XXXXXXXX.execute-api.eu-west-2.amazonaws.com/dev/messages
</code></pre><h2 id="Some-AWS-cli-commands"><a href="#Some-AWS-cli-commands" class="headerlink" title="Some AWS cli commands:"></a>Some AWS cli commands:</h2><p>To list all your apigateway endpoints:</p>
<pre><code>aws apigateway get-rest-apis
</code></pre><p>Show all lambda functions:</p>
<pre><code>aws lambda list-functions | grep FunctionName
</code></pre><h2 id="Delete-the-AWS-resources"><a href="#Delete-the-AWS-resources" class="headerlink" title="Delete the AWS resources"></a>Delete the AWS resources</h2><pre><code>AWS_ACCESS_KEY_ID=XXXXXXXX AWS_SECRET_ACCESS_KEY=XXXXXXXX jets delete
</code></pre><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.infoq.cn/article/FSPhFgYw769V*brbEyJW" target="_blank" rel="noopener">https://www.infoq.cn/article/FSPhFgYw769V*brbEyJW</a><br><a href="https://www.twilio.com/blog/serverless-ruby-on-aws-lambda-with-the-jets-framework" target="_blank" rel="noopener">https://www.twilio.com/blog/serverless-ruby-on-aws-lambda-with-the-jets-framework</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/ruby-aws-lambda/" data-id="ck1c0wtj100005205esosyt3j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/">aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-aws-lambda" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/python-aws-lambda/" class="article-date">
  <time datetime="2019-10-03T21:40:12.000Z" itemprop="datePublished">2019-10-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/python-aws-lambda/">Develop an AWS Lambda with Python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Install-serverless-framework"><a href="#Install-serverless-framework" class="headerlink" title="Install serverless framework"></a>Install serverless framework</h2><pre><code>npm install -g serverless
</code></pre><h2 id="Create-the-project"><a href="#Create-the-project" class="headerlink" title="Create the project"></a>Create the project</h2><pre><code>mkdir -p hello-world
cd hello-world
serverless create --template aws-python3 --name hello-world
</code></pre><h2 id="Create-AWS-user"><a href="#Create-AWS-user" class="headerlink" title="Create AWS user"></a>Create AWS user</h2><p>Create a user, e.g. serverless-user and add the access key and secret access key in the .aws/credentials:</p>
<pre><code>[serverless]
aws_access_key_id = XXXXXXXXXXXXXXXXXXXXXXX
aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXX
</code></pre><h2 id="Deploy-first-attempt"><a href="#Deploy-first-attempt" class="headerlink" title="Deploy - first attempt"></a>Deploy - first attempt</h2><pre><code>export AWS_PROFILE=&quot;serverless&quot;
serverless deploy  --region eu-west-1
</code></pre><p>Till now, you won’t see the APIGateway endpoint as it hasn’t been defined yet.</p>
<p>Edit serverless.yml:</p>
<pre><code>events:
    - http:
        path: hello
        method: get
</code></pre><p>Then run:</p>
<pre><code>serverless deploy -v
</code></pre><p>You will see the endpoint like: <a href="https://XXXXXXXXXX.execute-api.us-east-1.amazonaws.com/dev" target="_blank" rel="noopener">https://XXXXXXXXXX.execute-api.us-east-1.amazonaws.com/dev</a></p>
<p>The service can be tested by this command:</p>
<pre><code>sls invoke -f hello
</code></pre><p>Make sure to remove AWS resources when they are not needed:</p>
<pre><code>serverless remove
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/python-aws-lambda/" data-id="ck1c0dgao0000xo05eyld631w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/">aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-build-a-slack-bot-in-python" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/how-to-build-a-slack-bot-in-python/" class="article-date">
  <time datetime="2019-09-29T21:40:12.000Z" itemprop="datePublished">2019-09-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/how-to-build-a-slack-bot-in-python/">How to build a Slack bot in Python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Install-slackclient"><a href="#Install-slackclient" class="headerlink" title="Install slackclient"></a>Install slackclient</h2><pre><code>pip3 install slackclient
</code></pre><h2 id="Create-Slack-app"><a href="#Create-Slack-app" class="headerlink" title="Create Slack app"></a>Create Slack app</h2><p>Visit: <a href="https://api.slack.com/apps" target="_blank" rel="noopener">https://api.slack.com/apps</a> to create a new bot</p>
<p><img src="https://user-images.githubusercontent.com/437701/65965620-d433dd80-e456-11e9-90d2-9a028a561813.png" alt="image"></p>
<p>In the following window, choose ‘Bots’</p>
<p><img src="https://user-images.githubusercontent.com/437701/65965695-f299d900-e456-11e9-8db0-997f251ede79.png" alt="image"></p>
<p>Add a bot user, e.g. ‘myalertbot’</p>
<p>Click your app, then click ‘Install your app to your workspace’.</p>
<p>Then you will have OAuth Access token and Bot User OAuth Access token.</p>
<h2 id="Send-messages-in-Slack-bot"><a href="#Send-messages-in-Slack-bot" class="headerlink" title="Send messages in Slack bot"></a>Send messages in Slack bot</h2><pre><code>import os
import slack

client = slack.WebClient(token=&apos;SLACK_API_TOKEN&apos;)
response = client.chat_postMessage(channel=&apos;#my channel&apos;, text=&quot;Hello world!&quot;)
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/how-to-build-a-slack-bot-in-python/" data-id="ck17vvq9s00003105id6mrrtk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/slack/">slack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-tips" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/python-tips/" class="article-date">
  <time datetime="2019-09-16T21:40:12.000Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/python-tips/">Python tips</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>Use the new way to format string</p>
<pre><code>&apos;One for {name}, one for me.&apos;.format(name=name)
</code></pre><p>OR</p>
<pre><code>&apos;One for {}, one for me.&apos;.format(name)
</code></pre><p>NOT the old way:</p>
<pre><code>&quot;One for %s, one for me.&quot; % name
</code></pre><p>Split string by line breaks and convert it into array:</p>
<pre><code>my_string.splitlines()      
</code></pre><h2 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h2><p>Using sorted over sort, will create a fresh copy of the list and avoids possible side effects.</p>
<pre><code>sorted_array = sorted(scores,reverse=True)
</code></pre><p>Also, Python automatically detect array boundaries, so no need to check like:</p>
<pre><code>return sorted_array[0:3] if len(sorted_array)&gt;=3 else sorted_array
</code></pre><p>Just </p>
<pre><code>return sorted(scores,reverse=True)[0:3]     
</code></pre><p>Or even simpler:</p>
<pre><code>return sorted(scores,reverse=True)[:3]        
</code></pre><h3 id="String-to-Array"><a href="#String-to-Array" class="headerlink" title="String to Array"></a>String to Array</h3><pre><code>s = &quot;1 2 3 4\n5 6 7 8\n9 8 7 6&quot;

&gt;&gt;&gt; lines = s.splitlines()
&gt;&gt;&gt; lines
[&apos;1 2 3 4&apos;, &apos;5 6 7 8&apos;, &apos;9 8 7 6&apos;]

&gt;&gt;&gt; rows = [[int(v) for v in row.split()] for row in lines]
&gt;&gt;&gt; rows
[[1, 2, 3, 4], [5, 6, 7, 8], [9, 8, 7, 6]]

&gt;&gt;&gt; [list(column) for column in zip(*rows)]
[[1, 5, 9], [2, 6, 8], [3, 7, 7], [4, 8, 6]]       
</code></pre><h2 id="Iterables"><a href="#Iterables" class="headerlink" title="Iterables"></a>Iterables</h2><h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><pre><code>s1 = &quot;AABBC&quot;
s2 = &quot;AABBD&quot;
s = zip(s1, s2)
&gt;&gt;&gt; list(zip(s1,s2))
[(&apos;A&apos;, &apos;A&apos;), (&apos;A&apos;, &apos;A&apos;), (&apos;B&apos;, &apos;B&apos;), (&apos;B&apos;, &apos;B&apos;), (&apos;C&apos;, &apos;D&apos;)]
&gt;&gt;&gt; sum(a!=b for a,b in zip(s1, s2))
1
</code></pre><h2 id="Code-refactoring"><a href="#Code-refactoring" class="headerlink" title="Code refactoring"></a>Code refactoring</h2><p>The following code:</p>
<pre><code>def convert(number):
    the_string = &apos;&apos;
    if number % 3 == 0:
        the_string += &apos;Pling&apos;
    if number % 5 == 0:
        the_string += &apos;Plang&apos;
    if number % 7 == 0:
        the_string += &apos;Plong&apos;
    return the_string or str(number)
</code></pre><p>Can be shorter and nicer like:</p>
<pre><code>def convert(number):
    drops = ((3, &apos;Pling&apos;), (5, &apos;Plang&apos;), (7, &apos;Plong&apos;))

    the_string = [s for n, s in drops if number % n==0]
    return &quot;&quot;.join(the_string) or str(number)
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://yfrankfeng.github.io/python-tips/" data-id="ck0nyb2w000008m05gm1nghi7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/">AWS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Heroku/">Heroku</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hyrax/">Hyrax</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ubuntu/">Ubuntu</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/aws/">aws</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blacklight/">blacklight</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hyrax/">hyrax</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ngrok/">ngrok</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/rails/">rails</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/samvera/">samvera</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/solr/">solr</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system/">system</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/">AWS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EC2/">EC2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elastic-IP/">Elastic IP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fedora/">Fedora</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IRIS/">IRIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Solr/">Solr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js/">Vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/access-control/">access control</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/">aws</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blacklight/">blacklight</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blacklights/">blacklights</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/branch/">branch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cms/">cms</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/content-blocks/">content blocks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/">elk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/facets/">facets</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fedora/">fedora</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google+</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heroku/">heroku</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hyrax/">hyrax</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kibana/">kibana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/localstack/">localstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logstash/">logstash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ngrok/">ngrok</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/notification/">notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/">oauth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails/">rails</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/refinery/">refinery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/">ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/s3/">s3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/samvera/">samvera</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slack/">slack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solr/">solr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/turbolinks/">turbolinks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpacker/">webpacker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/">zsh</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AWS/" style="font-size: 10px;">AWS</a> <a href="/tags/EC2/" style="font-size: 10px;">EC2</a> <a href="/tags/Elastic-IP/" style="font-size: 10px;">Elastic IP</a> <a href="/tags/Fedora/" style="font-size: 10px;">Fedora</a> <a href="/tags/IRIS/" style="font-size: 10px;">IRIS</a> <a href="/tags/Java/" style="font-size: 11.67px;">Java</a> <a href="/tags/Solr/" style="font-size: 10px;">Solr</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/Vue-js/" style="font-size: 10px;">Vue.js</a> <a href="/tags/access-control/" style="font-size: 10px;">access control</a> <a href="/tags/aws/" style="font-size: 13.33px;">aws</a> <a href="/tags/blacklight/" style="font-size: 13.33px;">blacklight</a> <a href="/tags/blacklights/" style="font-size: 13.33px;">blacklights</a> <a href="/tags/branch/" style="font-size: 10px;">branch</a> <a href="/tags/cms/" style="font-size: 10px;">cms</a> <a href="/tags/content-blocks/" style="font-size: 10px;">content blocks</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/elk/" style="font-size: 10px;">elk</a> <a href="/tags/facets/" style="font-size: 10px;">facets</a> <a href="/tags/fedora/" style="font-size: 15px;">fedora</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/google/" style="font-size: 10px;">google+</a> <a href="/tags/heroku/" style="font-size: 11.67px;">heroku</a> <a href="/tags/hyrax/" style="font-size: 16.67px;">hyrax</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/localstack/" style="font-size: 10px;">localstack</a> <a href="/tags/logstash/" style="font-size: 10px;">logstash</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/ngrok/" style="font-size: 10px;">ngrok</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/notification/" style="font-size: 10px;">notification</a> <a href="/tags/oauth/" style="font-size: 10px;">oauth</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/rails/" style="font-size: 20px;">rails</a> <a href="/tags/refinery/" style="font-size: 10px;">refinery</a> <a href="/tags/ruby/" style="font-size: 13.33px;">ruby</a> <a href="/tags/s3/" style="font-size: 10px;">s3</a> <a href="/tags/samvera/" style="font-size: 18.33px;">samvera</a> <a href="/tags/slack/" style="font-size: 10px;">slack</a> <a href="/tags/solr/" style="font-size: 20px;">solr</a> <a href="/tags/tool/" style="font-size: 10px;">tool</a> <a href="/tags/turbolinks/" style="font-size: 10px;">turbolinks</a> <a href="/tags/vue-js/" style="font-size: 10px;">vue.js</a> <a href="/tags/webpacker/" style="font-size: 10px;">webpacker</a> <a href="/tags/zsh/" style="font-size: 10px;">zsh</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/aws-s3-localstack/">AWS S3 localstack</a>
          </li>
        
          <li>
            <a href="/iris-migration/">IRIS migration</a>
          </li>
        
          <li>
            <a href="/ruby-tips/">Ruby tips</a>
          </li>
        
          <li>
            <a href="/rails-page-only-working-after-refresh/">Rails page only working after refresh?</a>
          </li>
        
          <li>
            <a href="/hyrax-content-blocks/">How does Hyrax content blocks work?</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Frank<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>